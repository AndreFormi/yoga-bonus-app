<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#F28402" />

  <link rel="manifest" href="./manifest.webmanifest">

  <!-- PWA / Icons -->
  <link rel="icon" href="./img/icon-192.png">
  <link rel="apple-touch-icon" href="./img/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;700;800;900&display=swap" rel="stylesheet">
  <title>Stuhl-Yoga f√ºr Senioren</title>

  <style>
    :root{
      --bg:#F28402;
      --bg2:#D97002;
      --card:#F9F6F3;
      --text:#4B092D;
      --white:#F9F6F3;
      --accent:#03FBE6;
      --accent2:#4B092D;
      --muted: rgba(249,246,243,.85);
      --shadow: 0 10px 28px rgba(0,0,0,.18);
      --stroke: rgba(75,9,45,.18);
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      margin:0;
      padding:18px;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color: var(--white);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }

    h1{
      font-family: "Bebas Neue", Inter, sans-serif;
      letter-spacing: 1px;
      font-size: 46px;
      margin:0;
      line-height: .95;
    }

    .sub{
      color: var(--muted);
      font-size:14px;
      margin: 6px 0 10px;
      line-height:1.35;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .badgeRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 12px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:.2px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.25);
      user-select:none;
    }

    .badge.purple{ background: var(--accent2); color: var(--white); }
    .badge.cyan{ background: var(--accent); color: #0b0b0b; border: 1px solid rgba(0,0,0,.15); }

    .navbtn{
      background: transparent;
      color: var(--white);
      border: 1px solid rgba(249,246,243,.65);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
    }

    .card{
      background: var(--card);
      color: var(--text);
      border-radius: 18px;
      padding: 16px;
      margin: 12px 0;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }

    .card h2{ margin:0 0 10px; font-size:18px; }

    .mutedDark{
      opacity:.86;
      font-size:14px;
      line-height:1.35;
    }

    button{
      background: var(--accent);
      color: #0b0b0b;
      padding: 12px 14px;
      border: 0;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
    }

    button.secondary{
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(75,9,45,.28);
    }

    input, select{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(75,9,45,.22);
      background: rgba(255,255,255,.78);
      color: var(--text);
      width: min(420px, 100%);
      outline: none;
      font-weight: 700;
    }

    .big{
      font-size: 52px;
      font-weight: 900;
      letter-spacing: 1px;
      margin-top: 2px;
    }

    .pill{
      display:inline-block;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(75,9,45,.25);
      background: rgba(75,9,45,.08);
      font-size: 12px;
      font-weight: 900;
    }

    .list{ display:grid; gap:10px; }

    .item{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(75,9,45,.18);
      background: rgba(255,255,255,.68);
      cursor:pointer;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }

    .item:hover{ border-color: rgba(75,9,45,.35); }

    .thumb{
      width:78px;
      min-width:78px;
      height:78px;
      border-radius:14px;
      object-fit:cover;
      border: 1px solid rgba(75,9,45,.18);
      background: rgba(75,9,45,.06);
    }

    ul{ margin: 10px 0 0 18px; }

    .hide{ display:none; }

    .heroImg{
      width:100%;
      height:auto;
      border-radius: 16px;
      border: 1px solid rgba(75,9,45,.18);
      box-shadow: 0 10px 22px rgba(0,0,0,.12);
      margin: 10px 0 8px;
      background: rgba(75,9,45,.06);
    }

    .sectionTitle{
      font-weight: 900;
      letter-spacing: .2px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(75,9,45,.08);
      border: 1px solid rgba(75,9,45,.18);
      margin-top: 6px;
    }

    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      user-select:none;
      font-weight: 900;
      font-size: 13px;
    }
    .toggle input{ width:auto; }

    .miniBox{
      margin: 10px 0 0;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(75,9,45,.18);
      background: rgba(255,255,255,.68);
    }
    .miniBox h3{
      margin:0 0 6px;
      font-size:14px;
    }
    .miniBox ul{
      margin: 6px 0 0 18px;
    }

    /* Install box (pi√π professionale) */
    .installCard{
      padding:14px;
      margin-top:10px;
    }
    .installHead{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .installIcon{
      width:78px;
      height:78px;
      border-radius:22px;
      display:block;
      border: 1px solid rgba(75,9,45,.18);
      background: rgba(75,9,45,.06);
    }
    .installTitle{
      font-weight:900;
      font-size:16px;
      margin-bottom:2px;
      letter-spacing:.2px;
    }
    .installPills{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .installBtn{
      background: var(--accent2);
      color: var(--white);
      border: 1px solid rgba(0,0,0,.12);
    }
    .installBtn:active{ transform: translateY(1px); }

    /* Small helper row under timers */
    .timerToggles{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(75,9,45,.12);
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>Stuhl-Yoga f√ºr Senioren</h1>

      <!-- INSTALL BOX -->
      <div class="card installCard" id="installCard">
        <div class="installHead">
          <img src="./img/icon-192.png" alt="Stuhl-Yoga Icon" class="installIcon">
          <div>
            <div class="installTitle">App installieren (optional)</div>
            <div class="mutedDark" id="installHint">
              Du kannst die App auch direkt im Browser benutzen.
            </div>

            <div class="installPills">
              <span class="pill">Schneller Start</span>
              <span class="pill">Offline nutzbar</span>
              <span class="pill">Ohne Login</span>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="installBtn" class="installBtn hide">‚¨áÔ∏è Installieren</button>
          <button id="dismissInstall" class="secondary">Nicht jetzt</button>
        </div>

        <div class="mutedDark" id="installFallback" style="margin-top:10px; display:none;">
          <div><b>Android:</b> bitte in <b>Chrome</b> √∂ffnen ‚Üí Men√º (‚ãÆ) ‚Üí <b>‚ÄûApp installieren‚Äú</b>.</div>
          <div style="margin-top:6px;"><b>iPhone:</b> in <b>Safari</b> √∂ffnen ‚Üí Teilen ‚Üí <b>‚ÄûZum Home-Bildschirm‚Äú</b>.</div>
        </div>
      </div>
    </div>

    <div class="row">
      <button id="viewTimer" class="navbtn">‚è± Routinen</button>
      <button id="viewPoses" class="navbtn">üßò √úbungen</button>
    </div>
  </div>

  <div class="badgeRow">
    <div class="badge purple">10 MINUTEN AM TAG</div>
    <div class="badge cyan">Routinen + Timer</div>
  </div>

  <!-- ROUTINEN VIEW -->
  <section id="timerView">
    <div class="card" id="routineTop">
      <div class="row" style="justify-content:space-between;align-items:flex-start;">
        <h2 style="margin:0;">Routine ausw√§hlen</h2>
        <div class="row">
          <label class="toggle" title="Tick jede Sekunde (optional)">
            <input type="checkbox" id="tickToggle">
            üîä Tick
          </label>
          <label class="toggle" title="Gong am Ende">
            <input type="checkbox" id="gongToggle">
            üîî Gong
          </label>
        </div>
      </div>

      <img id="routineImg" class="heroImg" alt="Routine Bild" />

      <div class="row" style="justify-content:space-between;">
        <label class="mutedDark">
          Auswahl:
          <select id="routine"></select>
        </label>

        <div class="row">
          <span class="pill" id="routineDurationPill">Dauer: ‚Äî</span>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="start">Start</button>
        <button id="pause" class="secondary">Pause</button>
        <button id="prev" class="secondary">‚Üê Zur√ºck</button>
        <button id="skip" class="secondary">Weiter ‚Üí</button>
        <button id="reset" class="secondary">Reset</button>
      </div>
    </div>

    <div class="card" id="routineTimerCard">
      <h2 id="poseName">Bereit</h2>

      <img id="poseImg" class="heroImg hide" alt="√úbung Bild" />

      <div class="big" id="timer">00:00</div>
      <div class="mutedDark" id="poseInfo">W√§hle eine Routine und dr√ºcke Start.</div>

      <div id="poseMiniBox" class="miniBox hide">
        <h3>Anleitung (kurz)</h3>
        <ul id="poseMiniSteps"></ul>
      </div>

      <div style="margin-top:12px" class="row">
        <span class="pill" id="stepPill">Schritt 0/0</span>
        <span class="pill" id="routinePill">‚Äî</span>
      </div>

      <div class="timerToggles">
        <label class="toggle" title="Tick jede Sekunde (optional)">
          <input type="checkbox" id="tickToggle3">
          üîä Tick
        </label>
        <label class="toggle" title="Gong am Ende">
          <input type="checkbox" id="gongToggle3">
          üîî Gong
        </label>
      </div>

      <div class="row hide" id="doneActions" style="margin-top:12px">
        <button id="again">Nochmal</button>
        <button id="toExercises" class="secondary">Zu den √úbungen</button>
        <button id="otherRoutine" class="secondary">Andere Routine</button>
      </div>
    </div>
  </section>

  <!-- √úBUNGEN VIEW -->
  <section id="posesView" class="hide">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start;">
        <h2 style="margin:0;">√úbungen</h2>
        <div class="row">
          <label class="toggle" title="Tick jede Sekunde (optional)">
            <input type="checkbox" id="tickToggle2">
            üîä Tick
          </label>
          <label class="toggle" title="Gong am Ende">
            <input type="checkbox" id="gongToggle2">
            üîî Gong
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="search" placeholder="Suchen (z.B. R√ºcken, Nacken, Atmung)..." />
      </div>

      <div class="mutedDark" style="margin-top:10px">
        √ñffne eine √úbung und dr√ºcke <b>‚ÄûTimer starten‚Äú</b>.
      </div>
    </div>

    <div class="list" id="poseList"></div>

    <div class="card hide" id="poseDetail">
      <div class="row" style="justify-content:space-between">
        <h2 id="dName">‚Äî</h2>
        <div class="row">
          <button id="startPoseTimer">‚è± Timer starten</button>
          <button id="back" class="secondary">‚Üê Zur√ºck</button>
        </div>
      </div>

      <img id="dImg" class="heroImg" alt="√úbung Bild" />

      <div class="row" style="margin: 8px 0 12px">
        <span class="pill" id="dTime">‚Äî</span>
        <span class="pill" id="dBenefits">‚Äî</span>
      </div>

      <h3 style="margin:0 0 8px">Anleitung</h3>
      <ul id="dSteps"></ul>

      <h3 style="margin:14px 0 8px">H√§ufige Fehler</h3>
      <ul id="dErrors"></ul>

      <div id="singleTimerBox" class="card" style="margin:12px 0 0; padding:14px;">
        <div class="row" style="justify-content:space-between;align-items:baseline;">
          <div class="installTitle">√úbungs-Timer</div>
          <span class="pill" id="singleStepPill">‚Äî</span>
        </div>

        <div class="big" id="singleTimer">00:00</div>
        <div class="mutedDark" id="singleHint" style="margin-top:6px;">‚Äî</div>

        <div class="timerToggles">
          <label class="toggle" title="Tick jede Sekunde (optional)">
            <input type="checkbox" id="tickToggle4">
            üîä Tick
          </label>
          <label class="toggle" title="Gong am Ende">
            <input type="checkbox" id="gongToggle4">
            üîî Gong
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="singlePause" class="secondary">Pause</button>
          <button id="singleReset" class="secondary">Reset</button>
          <button id="singleNext">Noch eine √úbung ‚Üí</button>
        </div>
      </div>
    </div>
  </section>

  <script>
    // =========================
    // Smooth scroll helper
    // =========================
    function scrollToEl(el){
      if(!el) return;
      el.scrollIntoView({ behavior:"smooth", block:"start" });
    }

    // =========================
    // AUDIO (WebAudio): tick + gong (senza file)
    // =========================
    let audioCtx = null;
    function getAudioCtx(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioCtx;
    }

    function playTick(){
      if(!settings.tick) return;
      try{
        const ctx = getAudioCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "square";
        o.frequency.value = 1200;
        g.gain.value = 0.04;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 0.03);
      }catch(e){}
    }

    function playGong(){
      if(!settings.gong) return;
      try{
        const ctx = getAudioCtx();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.setValueAtTime(520, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(220, ctx.currentTime + 0.9);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.22, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1.1);
        o.connect(g); g.connect(ctx.destination);
        o.start();
        o.stop(ctx.currentTime + 1.15);
      }catch(e){}
    }

    // =========================
    // SETTINGS (saved)
    // =========================
    const settings = {
      tick: (localStorage.getItem("yoga_tick") || "0") === "1",
      gong: (localStorage.getItem("yoga_gong") || "1") === "1",
    };

    function syncToggles(){
      const tickIds = ["tickToggle","tickToggle2","tickToggle3","tickToggle4"];
      const gongIds = ["gongToggle","gongToggle2","gongToggle3","gongToggle4"];
      tickIds.forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.checked = settings.tick;
      });
      gongIds.forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.checked = settings.gong;
      });
    }

    function attachToggleHandlers(){
      const tickIds = ["tickToggle","tickToggle2","tickToggle3","tickToggle4"];
      tickIds.forEach(id=>{
        const el = document.getElementById(id);
        el?.addEventListener("change", (e)=>{
          settings.tick = !!e.target.checked;
          localStorage.setItem("yoga_tick", settings.tick ? "1" : "0");
          syncToggles();
        });
      });

      const gongIds = ["gongToggle","gongToggle2","gongToggle3","gongToggle4"];
      gongIds.forEach(id=>{
        const el = document.getElementById(id);
        el?.addEventListener("change", (e)=>{
          settings.gong = !!e.target.checked;
          localStorage.setItem("yoga_gong", settings.gong ? "1" : "0");
          syncToggles();
        });
      });
    }

    // =========================
    // DATI: √úBUNGEN (DE) + categoria
    // =========================
    const POSES = [/* ... INVARIATO: incolla qui il tuo array POSES ... */];

    // =========================
    // ROUTINEN
    // =========================
    const routines = [/* ... INVARIATO: incolla qui il tuo array routines ... */];

    // =========================
    // NAV
    // =========================
    const timerView = document.getElementById("timerView");
    const posesView = document.getElementById("posesView");
    document.getElementById("viewTimer").onclick = () => {
      timerView.classList.remove("hide");
      posesView.classList.add("hide");
    };
    document.getElementById("viewPoses").onclick = () => {
      posesView.classList.remove("hide");
      timerView.classList.add("hide");
      renderList();
      scrollToEl(posesView);
    };

    // =========================
    // ROUTINE SELECT
    // =========================
    const sel = document.getElementById("routine");
    routines.forEach((r,i)=> {
      const o=document.createElement("option");
      o.value=i;
      o.textContent=r.name;
      sel.appendChild(o);
    });

    const $routineImg = document.getElementById("routineImg");
    const $routineDurationPill = document.getElementById("routineDurationPill");
    function routineTotalSeconds(r){ return (r.steps||[]).reduce((a,s)=>a+(s.sec||0),0); }

    function updateRoutineUI(){
      const r = routines[+sel.value];
      $routineImg.src = r.image;
      $routineImg.alt = `Bild: ${r.name}`;
      const total = routineTotalSeconds(r);
      $routineDurationPill.textContent = `Dauer: ${Math.round(total/60)} min`;
    }
    updateRoutineUI();

    // =========================
    // TIMER (ROUTINE)
    // =========================
    let interval=null, stepIdx=0, remaining=0, paused=true, current=null;

    const $timer=document.getElementById("timer");
    const $pose=document.getElementById("poseName");
    const $info=document.getElementById("poseInfo");
    const $stepPill=document.getElementById("stepPill");
    const $routinePill=document.getElementById("routinePill");
    const $poseImg=document.getElementById("poseImg");
    const $doneActions=document.getElementById("doneActions");

    const $poseMiniBox=document.getElementById("poseMiniBox");
    const $poseMiniSteps=document.getElementById("poseMiniSteps");
    const $routineTimerCard = document.getElementById("routineTimerCard");

    function fmt(s){
      const m = Math.floor(s/60).toString().padStart(2,'0');
      const sec = (s%60).toString().padStart(2,'0');
      return `${m}:${sec}`;
    }
    function getPoseById(id){ return POSES.find(p=>p.id===id); }

    function setPoseImage(pose){
      if(!pose || !pose.immagine){
        $poseImg.classList.add("hide");
        $poseImg.removeAttribute("src");
        return;
      }
      $poseImg.src = pose.immagine;
      $poseImg.alt = `Bild: ${pose.nome}`;
      $poseImg.classList.remove("hide");
    }

    function setMiniInstructions(pose){
      if(!pose || !pose.istruzioni || pose.istruzioni.length === 0){
        $poseMiniBox.classList.add("hide");
        $poseMiniSteps.innerHTML = "";
        return;
      }
      const items = pose.istruzioni.slice(0,3);
      $poseMiniSteps.innerHTML = "";
      items.forEach(t=>{
        const li=document.createElement("li");
        li.textContent=t;
        $poseMiniSteps.appendChild(li);
      });
      $poseMiniBox.classList.remove("hide");
    }

    function loadStep(){
      const step = current.steps[stepIdx];
      const pose = getPoseById(step.poseId) || {nome:"√úbung", benefici:"", immagine:"", istruzioni:[]};
      remaining = step.sec;

      $pose.textContent = pose.nome;
      $info.textContent = pose.benefici || "‚Äî";
      $timer.textContent = fmt(remaining);
      $stepPill.textContent = `Schritt ${stepIdx+1}/${current.steps.length}`;
      $routinePill.textContent = current.name || "‚Äî";
      setPoseImage(pose);
      setMiniInstructions(pose);

      $doneActions.classList.add("hide");
    }

    function finishRoutine(){
      paused=true;
      clearInterval(interval);
      interval=null;

      $pose.textContent="Routine abgeschlossen ‚úÖ";
      $info.textContent="Was m√∂chtest du als N√§chstes machen?";
      $timer.textContent="00:00";
      $stepPill.textContent = `Schritt ${current.steps.length}/${current.steps.length}`;
      $routinePill.textContent = current.name || "‚Äî";
      setPoseImage(null);
      setMiniInstructions(null);

      $doneActions.classList.remove("hide");

      const done = JSON.parse(localStorage.getItem("yoga_done")||"[]");
      done.push({ts:Date.now(), routine:current.name});
      localStorage.setItem("yoga_done", JSON.stringify(done));

      playGong();
    }

    function tick(){
      if(paused) return;
      playTick();

      remaining--;
      $timer.textContent = fmt(Math.max(0,remaining));
      if(remaining <= 0){
        stepIdx++;
        if(stepIdx >= current.steps.length){
          finishRoutine();
          return;
        }
        loadStep();
      }
    }

    function hardResetRoutineUI(){
      paused=true; stepIdx=0; current=null;
      if(interval){ clearInterval(interval); interval=null; }
      $pose.textContent="Bereit";
      $info.textContent="W√§hle eine Routine und dr√ºcke Start.";
      $timer.textContent="00:00";
      $stepPill.textContent="Schritt 0/0";
      $routinePill.textContent="‚Äî";
      setPoseImage(null);
      setMiniInstructions(null);
      $doneActions.classList.add("hide");
    }

    document.getElementById("start").onclick = async () => {
      try{ await getAudioCtx().resume(); }catch(e){}
      if(!current){
        current = routines[+sel.value];
        stepIdx=0;
        loadStep();
      }
      paused=false;
      if(!interval) interval=setInterval(tick,1000);
      scrollToEl($routineTimerCard);
    };

    document.getElementById("pause").onclick = () => paused=true;

    document.getElementById("skip").onclick = () => {
      if(!current) return;
      stepIdx++;
      if(stepIdx >= current.steps.length){
        finishRoutine();
        return;
      }
      loadStep();
      scrollToEl($routineTimerCard);
    };

    document.getElementById("prev").onclick = () => {
      if(!current) return;
      if(stepIdx <= 0) return;
      stepIdx--;
      loadStep();
      scrollToEl($routineTimerCard);
    };

    document.getElementById("reset").onclick = () => hardResetRoutineUI();

    document.getElementById("again").onclick = async () => {
      try{ await getAudioCtx().resume(); }catch(e){}
      const selected = current ? current : routines[+sel.value];
      hardResetRoutineUI();
      current = selected;
      stepIdx = 0;
      loadStep();
      paused = false;
      if(!interval) interval=setInterval(tick,1000);
      scrollToEl($routineTimerCard);
    };

    document.getElementById("toExercises").onclick = () => {
      posesView.classList.remove("hide");
      timerView.classList.add("hide");
      renderList();
      scrollToEl(posesView);
    };

    document.getElementById("otherRoutine").onclick = () => {
      hardResetRoutineUI();
      document.getElementById("routineTop").scrollIntoView({behavior:"smooth", block:"start"});
    };

    sel.onchange = () => {
      updateRoutineUI();
      hardResetRoutineUI();
    };

    // =========================
    // √úBUNGEN: LISTA + CATEGORIE (INVARIATO)
    // =========================
    const $list = document.getElementById("poseList");
    const $search = document.getElementById("search");
    const $detail = document.getElementById("poseDetail");
    const $dImg = document.getElementById("dImg");
    const $singleTimerBox = document.getElementById("singleTimerBox");
    let selectedPoseId = null;

    const CATEGORY_ORDER = [
      "Atmung & Entspannung",
      "R√ºcken & Wirbels√§ule",
      "Nacken & Schultern",
      "H√ºfte & Beine"
    ];

    function renderList(){
      $detail.classList.add("hide");
      $list.classList.remove("hide");

      const q = ($search.value||"").trim().toLowerCase();

      const filtered = POSES
        .filter(p => {
          const text = (p.nome+" "+p.benefici+" "+(p.tags||[]).join(" ")+" "+(p.categoria||"")).toLowerCase();
          return !q || text.includes(q);
        })
        .sort((a,b)=>{
          const ca = CATEGORY_ORDER.indexOf(a.categoria||"");
          const cb = CATEGORY_ORDER.indexOf(b.categoria||"");
          if(ca !== cb) return ca - cb;
          return a.nome.localeCompare(b.nome, "de");
        });

      $list.innerHTML = "";

      let lastCat = null;
      filtered.forEach(p => {
        if(p.categoria !== lastCat){
          const cat = document.createElement("div");
          cat.className = "sectionTitle";
          cat.textContent = p.categoria || "√úbungen";
          $list.appendChild(cat);
          lastCat = p.categoria;
        }

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <img class="thumb" src="${p.immagine}" alt="thumb ${p.nome}">
          <div>
            <div style="font-weight:900;margin-bottom:4px;">${p.nome}</div>
            <div class="mutedDark">${p.benefici}</div>
            <div style="margin-top:10px" class="row">
              <span class="pill">~ ${Math.max(1, Math.round((p.durataConsigliataSec||60)/60))} min</span>
            </div>
          </div>
        `;
        div.onclick = () => showDetail(p.id);
        $list.appendChild(div);
      });

      if(filtered.length === 0){
        const empty = document.createElement("div");
        empty.className="card";
        empty.innerHTML = `<div class="mutedDark">Keine Treffer. Bitte andere Suchw√∂rter probieren.</div>`;
        $list.appendChild(empty);
      }
    }

    function showDetail(id){
      selectedPoseId = id;
      const p = getPoseById(id);
      if(!p) return;

      document.getElementById("dName").textContent = p.nome;
      document.getElementById("dTime").textContent = `Empfohlene Dauer: ${fmt(p.durataConsigliataSec||60)}`;
      document.getElementById("dBenefits").textContent = p.benefici;

      $dImg.src = p.immagine;
      $dImg.alt = `Bild: ${p.nome}`;

      const steps = document.getElementById("dSteps");
      const errs = document.getElementById("dErrors");
      steps.innerHTML = ""; errs.innerHTML = "";

      (p.istruzioni||[]).forEach(s => {
        const li=document.createElement("li");
        li.textContent=s;
        steps.appendChild(li);
      });

      (p.erroriComuni||[]).forEach(s => {
        const li=document.createElement("li");
        li.textContent=s;
        errs.appendChild(li);
      });

      resetSingleTimerUI();

      $list.classList.add("hide");
      $detail.classList.remove("hide");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    document.getElementById("back").onclick = () => {
      $detail.classList.add("hide");
      $list.classList.remove("hide");
      resetSingleTimerUI();
      window.scrollTo({top:0, behavior:"smooth"});
    };

    $search.oninput = renderList;

    // =========================
    // SINGLE TIMER (INVARIATO)
    // =========================
    let singleInterval = null;
    let singleRemaining = 0;

    const $singleTimer = document.getElementById("singleTimer");
    const $singleStepPill = document.getElementById("singleStepPill");
    const $singleHint = document.getElementById("singleHint");

    function resetSingleTimerUI(){
      if(singleInterval){
        clearInterval(singleInterval);
        singleInterval = null;
      }
      singleRemaining = 0;
      $singleTimer.textContent = "00:00";
      $singleStepPill.textContent = "‚Äî";
      $singleHint.textContent = "‚Äî";
    }

    function startSingleTimer(secs){
      singleRemaining = secs;
      $singleTimer.textContent = fmt(Math.max(0, singleRemaining));
      $singleStepPill.textContent = "√úbung l√§uft";
      $singleHint.textContent = "Du kannst danach direkt eine weitere √úbung ausw√§hlen.";

      if(singleInterval) clearInterval(singleInterval);
      singleInterval = setInterval(() => {
        playTick();

        singleRemaining--;
        $singleTimer.textContent = fmt(Math.max(0, singleRemaining));

        if(singleRemaining <= 0){
          clearInterval(singleInterval);
          singleInterval = null;
          $singleStepPill.textContent = "Fertig ‚úÖ";
          $singleHint.textContent = "M√∂chtest du eine weitere √úbung machen?";
          playGong();
        }
      }, 1000);
    }

    document.getElementById("startPoseTimer").onclick = async () => {
      try{ await getAudioCtx().resume(); }catch(e){}
      if(!selectedPoseId) return;
      const p = getPoseById(selectedPoseId);
      if(!p) return;
      const secs = p.durataConsigliataSec ? p.durataConsigliataSec : 60;
      startSingleTimer(secs);
      scrollToEl($singleTimerBox);
    };

    document.getElementById("singlePause").onclick = () => {
      if(singleInterval){
        clearInterval(singleInterval);
        singleInterval = null;
        $singleStepPill.textContent = "Pausiert";
        $singleHint.textContent = "Weiter mit ‚ÄûTimer starten‚Äú (oder Reset).";
      }
    };

    document.getElementById("singleReset").onclick = () => resetSingleTimerUI();

    document.getElementById("singleNext").onclick = () => {
      resetSingleTimerUI();
      $detail.classList.add("hide");
      $list.classList.remove("hide");
      window.scrollTo({top:0, behavior:"smooth"});
    };

    // =========================
    // INSTALL: banner fisso + sparisce se gi√† installata
    // =========================
    const installCard = document.getElementById("installCard");
    const installBtn = document.getElementById("installBtn");
    const installFallback = document.getElementById("installFallback");
    const dismissInstall = document.getElementById("dismissInstall");

    function isStandalone(){
      // iOS + Android
      return window.matchMedia("(display-mode: standalone)").matches
        || window.navigator.standalone === true;
    }

    // Se gi√† installata: nascondi banner
    if(isStandalone()){
      installCard.classList.add("hide");
    }

    // Se utente lo chiude: ricorda (1 settimana)
    const DISMISS_KEY = "yoga_install_dismissed_ts";
    const dismissedTs = parseInt(localStorage.getItem(DISMISS_KEY) || "0", 10);
    const oneWeek = 7 * 24 * 60 * 60 * 1000;
    if(dismissedTs && (Date.now() - dismissedTs) < oneWeek){
      installCard.classList.add("hide");
    }

    dismissInstall.addEventListener("click", () => {
      localStorage.setItem(DISMISS_KEY, String(Date.now()));
      installCard.classList.add("hide");
    });

    // Android/Chrome event
    let deferredPrompt = null;

    // Dopo 2.5s: se non c'√® prompt, mostra istruzioni manuali (iPhone / in-app browser)
    setTimeout(() => {
      if(isStandalone()) return;
      if(!deferredPrompt && installBtn.classList.contains("hide")){
        installFallback.style.display = "block";
      }
    }, 2500);

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.classList.remove("hide");
      installFallback.style.display = "none";
    });

    installBtn.addEventListener("click", async () => {
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      // Non lo nascondo per forza: lasciamolo, ma se installano davvero spesso sparisce al reload
      // installBtn.classList.add("hide");
    });

    // Se installano: nascondi banner
    window.addEventListener("appinstalled", () => {
      installCard.classList.add("hide");
    });

    // =========================
    // INIT
    // =========================
    syncToggles();
    attachToggleHandlers();

    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
